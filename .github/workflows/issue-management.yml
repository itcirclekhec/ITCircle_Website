name: Issue Management and Community

on:
  issues:
    types: [opened, labeled, unlabeled]
  pull_request_target:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  # Auto-label issues based on content
  auto-label-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Auto-label issue
      uses: github/super-linter/slim@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        issue-number: ${{ github.event.issue.number }}
        labels: |
          - if: contains(github.event.issue.body, 'bug') || contains(github.event.issue.body, 'error') || contains(github.event.issue.body, 'fix')
            then: bug
          - if: contains(github.event.issue.body, 'feature') || contains(github.event.issue.body, 'enhancement') || contains(github.event.issue.body, 'add')
            then: enhancement
          - if: contains(github.event.issue.body, 'documentation') || contains(github.event.issue.body, 'docs') || contains(github.event.issue.body, 'readme')
            then: documentation
          - if: contains(github.event.issue.body, 'good first issue') || contains(github.event.issue.body, 'beginner') || contains(github.event.issue.body, 'easy')
            then: good first issue
          - if: contains(github.event.issue.body, 'help wanted') || contains(github.event.issue.body, 'contribution') || contains(github.event.issue.body, 'volunteer')
            then: help wanted

  # Welcome new contributors
  welcome-new-contributors:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened' && github.event.issue.author_association == 'FIRST_TIME_CONTRIBUTOR'

    steps:
    - name: Welcome message for new contributors
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `🎉 **Welcome to IT Circle!** 🎉

          Thank you for opening your first issue! We're excited to have you join our community at Khwopa Engineering College.

          **Next Steps:**
          1. 📖 Read our [Contributing Guide](CONTRIBUTING.md) to understand our development process
          2. 🏷️ Check if your issue fits any of our existing labels
          3. 💬 Feel free to ask questions - our community is here to help!

          **Student Contributors:**
          - This is a great opportunity to learn and contribute to a real project
          - Faculty advisors and senior students provide mentorship
          - Your contributions help fellow students and build your portfolio

          **Need Help?**
          - 📧 Email: itcircle@khec.edu.np
          - 🏢 Office Hours: Mon-Fri, 10 AM - 5 PM NPT
          - 💬 Ask questions in the issue comments

          ---
          *Built with ❤️ by IT Circle, Khwopa Engineering College*`
          })

  # Label first-time contributors
  label-first-contributors:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'opened' && github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    steps:
    - name: Add first-time contributor label
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['first-time contributor', 'good first issue']
          })

  # Congratulate contributors on first merged PR
  congratulate-first-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    steps:
    - name: Congratulate first-time contributor
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `🎊 **Congratulations on your first merged PR!** 🎊

          Amazing work! You've successfully contributed to the IT Circle project. This is a significant achievement that demonstrates your growing skills in software development.

          **What's Next:**
          - 🌟 Consider tackling more challenging issues
          - 👥 Help other new contributors by reviewing their PRs
          - 📚 Share your learning experience with fellow students
          - 🏆 Your contribution will be recognized in our README

          **Recognition:**
          Your GitHub profile will show this contribution, which is valuable for:
          - Internship applications
          - Job opportunities
          - Building your developer portfolio
          - Academic recognition

          **Keep Contributing:**
          - Look for issues labeled "good first issue" for your next contribution
          - Join our community discussions
          - Consider becoming a regular contributor

          ---
          *Thank you for being an amazing part of our IT Circle community! 🚀*`
          })

  # Auto-assign issues to maintainers
  auto-assign-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
    - name: Auto-assign to maintainers
      uses: pozil/auto-assign-issue@v2
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        assignees: ${{ secrets.MAINTAINER_USERNAME }}
        allow-self-assign: true

  # Add size labels to PRs
  pr-size-label:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'opened'

    steps:
    - name: Add size label
      uses: codity/git-pr-size-labeler@master
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        xs_label: 'size/xs'
        xs_max_size: 10
        s_label: 'size/s'
        s_max_size: 50
        m_label: 'size/m'
        m_max_size: 200
        l_label: 'size/l'
        l_max_size: 500
        xl_label: 'size/xl'
        message_if_xl: |
          This PR is very large. Consider splitting it into multiple smaller PRs for easier review and faster feedback.

  # Stale issue management
  stale-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
    - name: Mark stale issues
      uses: actions/stale@v8
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        stale-issue-message: |
          This issue has been automatically marked as stale because it has not had recent activity. If this issue is still relevant, please comment with an update. Otherwise, it will be closed in 7 days.

          Thank you for your contributions! 🙏
        stale-pr-message: |
          This PR has been automatically marked as stale because it has not had recent activity. If you're still working on this, please comment with an update. Otherwise, it will be closed in 7 days.

          Thank you for your contributions! 🙏
        close-issue-message: |
          This issue has been automatically closed because it has not had recent activity. If this issue is still relevant, please open a new issue with updated information.

          Thank you for your contributions! 🙏
        close-pr-message: |
          This PR has been automatically closed because it has not had recent activity. If you're still working on this, please open a new PR with updated changes.

          Thank you for your contributions! 🙏
        days-before-stale: 30
        days-before-close: 7
        stale-issue-label: 'stale'
        stale-pr-label: 'stale'
        exempt-issue-labels: 'pinned,security,good first issue,help wanted'
        exempt-pr-labels: 'WIP,work in progress'
        operations-per-run: 100
